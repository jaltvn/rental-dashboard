<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vancouver Rental Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Recharts for charts -->
    <script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js"></script>
    
    <!-- PapaParse for CSV -->
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;

        // Your CSV URL on GitHub Pages
        const GITHUB_CSV_URL = 'https://jaltvn.github.io/rental-dashboard/rental-unit-data_24052025.csv';

        // Sample data as fallback
        const SAMPLE_DATA = `ID,Date Added,Building,Unit Size,Rent,Avg Sq Ft,Avg Rent/sqft,Neighbourhood,City,In-Suite Laundry,Pet Friendly,Parking,EV Charging,AC,Furnished,Gym
88553012,Apr-25,revolve,studio," $2,275.00 ",347, $6.56 ,Mount Pleasant,Vancouver,TRUE,TRUE,TRUE,TRUE,TRUE,FALSE,FALSE
D63A4C90,Apr-25,revolve,studio," $2,400.00 ",377, $6.37 ,Mount Pleasant,Vancouver,TRUE,TRUE,TRUE,TRUE,TRUE,FALSE,FALSE
C9463EDF,Apr-25,revolve,studio," $2,600.00 ",369, $7.05 ,Mount Pleasant,Vancouver,TRUE,TRUE,TRUE,TRUE,TRUE,FALSE,FALSE
81933801,Apr-25,revolve,1bed," $2,500.00 ",504, $4.96 ,Mount Pleasant,Vancouver,TRUE,TRUE,TRUE,TRUE,TRUE,FALSE,FALSE
BC3EB645,Apr-25,revolve,1bed," $2,600.00 ",468, $5.56 ,Mount Pleasant,Vancouver,TRUE,TRUE,TRUE,TRUE,TRUE,FALSE,FALSE
75F57F85,Apr-25,revolve,1bed," $2,650.00 ",477, $5.56 ,Mount Pleasant,Vancouver,TRUE,TRUE,TRUE,TRUE,TRUE,FALSE,FALSE
6935A9FB,Apr-25,revolve,2bed," $3,400.00 ",657, $5.18 ,Mount Pleasant,Vancouver,TRUE,TRUE,TRUE,TRUE,TRUE,FALSE,FALSE
30F81104,Apr-25,revolve,2bed," $3,500.00 ",649, $5.39 ,Mount Pleasant,Vancouver,TRUE,TRUE,TRUE,TRUE,TRUE,FALSE,FALSE
1352B810,Apr-25,revolve,2bed," $3,500.00 ",632, $5.54 ,Mount Pleasant,Vancouver,TRUE,TRUE,TRUE,TRUE,TRUE,FALSE,FALSE
CE60F460,Apr-25,revolve,3bed," $4,500.00 ",1039, $4.33 ,Mount Pleasant,Vancouver,TRUE,TRUE,TRUE,TRUE,TRUE,FALSE,FALSE
D90BE070,Apr-25,hyland,studio," $2,255.00 ",400, $5.64 ,Kensington-Cedar Cottage,Vancouver,TRUE,TRUE,TRUE,FALSE,FALSE,FALSE,FALSE
FCB9E6E0,Apr-25,hyland,1bed," $2,935.00 ",431, $6.81 ,Kensington-Cedar Cottage,Vancouver,TRUE,TRUE,TRUE,FALSE,FALSE,FALSE,FALSE
E0FD5B7E,Apr-25,hyland,2bed," $3,345.00 ",700, $4.78 ,Kensington-Cedar Cottage,Vancouver,TRUE,TRUE,TRUE,FALSE,FALSE,FALSE,FALSE
83831FBD,Apr-25,hyland,3bed," $4,945.00 ",1029, $4.81 ,Kensington-Cedar Cottage,Vancouver,TRUE,TRUE,TRUE,FALSE,FALSE,FALSE,FALSE
BEE45B80,Apr-25,Fynn,1bed," $2,173.00 ",568, $3.83 ,River District,Vancouver,TRUE,TRUE,TRUE,FALSE,FALSE,FALSE,TRUE
82A0D3B7,Apr-25,Fynn,2bed," $2,922.00 ",725, $4.03 ,River District,Vancouver,TRUE,TRUE,TRUE,FALSE,FALSE,FALSE,TRUE
1B84BF25,Apr-25,Fynn,3bed," $3,331.00 ",975, $3.42 ,River District,Vancouver,TRUE,TRUE,TRUE,FALSE,FALSE,FALSE,TRUE
ECD27CB2,Apr-25,Cedar Lane,studio," $2,275.00 ",450, $5.06 ,Kensington-Cedar Cottage,Vancouver,TRUE,TRUE,TRUE,TRUE,FALSE,FALSE,FALSE
FEE78870,Apr-25,Cedar Lane,studio," $2,295.00 ",475, $4.83 ,Kensington-Cedar Cottage,Vancouver,TRUE,TRUE,TRUE,TRUE,FALSE,FALSE,FALSE
26E2CBF3,Apr-25,Cedar Lane,studio," $2,325.00 ",485, $4.79 ,Kensington-Cedar Cottage,Vancouver,TRUE,TRUE,TRUE,TRUE,FALSE,FALSE,FALSE`;

        const amenities = [
          { id: 'in-suite-laundry', name: 'In-Suite Laundry' },
          { id: 'pet-friendly', name: 'Pet Friendly' },
          { id: 'parking', name: 'Parking' },
          { id: 'ev-charging', name: 'EV Charging' },
          { id: 'ac', name: 'AC' },
          { id: 'furnished', name: 'Furnished' },
          { id: 'gym', name: 'Gym' }
        ];

        const amenityColumnMap = {
          'in-suite-laundry': 'In-Suite Laundry',
          'pet-friendly': 'Pet Friendly',
          'parking': 'Parking',
          'ev-charging': 'EV Charging',
          'ac': 'AC',
          'furnished': 'Furnished',
          'gym': 'Gym'
        };

        // Helper functions
        const parseCurrency = (value) => {
          if (typeof value === 'number') return value;
          if (typeof value === 'string') {
            const cleanValue = value.replace(/[\s$,]/g, '');
            return parseFloat(cleanValue) || 0;
          }
          return 0;
        };

        const parseDate = (dateStr) => {
          if (!dateStr) return new Date();
          const [month, year] = dateStr.split('-');
          const monthNames = {
            'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
            'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11
          };
          const monthIndex = monthNames[month] || 0;
          const fullYear = year ? 2000 + parseInt(year) : 2025;
          return new Date(fullYear, monthIndex, 1);
        };

        // Simple UI components (replacing shadcn/ui)
        const Card = ({ children, className = "" }) => (
          <div className={`bg-white rounded-lg border shadow-sm ${className}`}>
            {children}
          </div>
        );

        const CardHeader = ({ children, className = "" }) => (
          <div className={`p-6 pb-4 ${className}`}>
            {children}
          </div>
        );

        const CardTitle = ({ children, className = "" }) => (
          <h3 className={`text-lg font-semibold ${className}`}>
            {children}
          </h3>
        );

        const CardContent = ({ children, className = "" }) => (
          <div className={`p-6 pt-0 ${className}`}>
            {children}
          </div>
        );

        const Button = ({ children, onClick, className = "", variant = "default" }) => {
          const baseClasses = "px-4 py-2 rounded-md font-medium transition-colors";
          const variantClasses = variant === "outline" 
            ? "border border-gray-300 bg-white text-gray-700 hover:bg-gray-50"
            : "bg-blue-600 text-white hover:bg-blue-700";
          
          return (
            <button 
              onClick={onClick}
              className={`${baseClasses} ${variantClasses} ${className}`}
            >
              {children}
            </button>
          );
        };

        const Select = ({ value, onChange, children, className = "" }) => (
          <select 
            value={value} 
            onChange={(e) => onChange(e.target.value)}
            className={`px-3 py-2 border border-gray-300 rounded-md bg-white ${className}`}
          >
            {children}
          </select>
        );

        const VancouverRentalDashboard = () => {
          const [selectedRegion, setSelectedRegion] = useState('Vancouver');
          const [selectedAmenities, setSelectedAmenities] = useState([]);
          const [showAmenityFilter, setShowAmenityFilter] = useState(false);
          const [rentalData, setRentalData] = useState([]);
          const [regions, setRegions] = useState([]);
          const [loading, setLoading] = useState(true);
          const [error, setError] = useState(null);
          const [usingSampleData, setUsingSampleData] = useState(false);

          useEffect(() => {
            const loadData = async () => {
              let csvText = null;
              let usingSample = false;

              try {
                console.log('Trying to fetch from:', GITHUB_CSV_URL);
                const response = await fetch(GITHUB_CSV_URL);
                
                if (response.ok) {
                  csvText = await response.text();
                  console.log('Successfully fetched live data');
                } else {
                  throw new Error(`HTTP ${response.status}`);
                }
              } catch (error) {
                console.log('Failed to fetch live data, using sample:', error.message);
                csvText = SAMPLE_DATA;
                usingSample = true;
              }

              try {
                const parseResult = Papa.parse(csvText, {
                  header: true,
                  skipEmptyLines: true,
                  transformHeader: (header) => header.trim()
                });

                const data = parseResult.data;
                console.log('Parsed data:', data.length, 'rows');

                const processedData = data.map(row => ({
                  ...row,
                  'Date Added': parseDate(row['Date Added']),
                  'Unit Size': row['Unit Size'] === 'Studio' ? 'studio' : row['Unit Size'],
                  'Rent': parseCurrency(row['Rent']),
                  'Avg Rent/sqft': parseCurrency(row['Avg Rent/sqft']),
                  'Avg Sq Ft': parseInt(row['Avg Sq Ft']) || 0,
                  ...Object.fromEntries(
                    Object.values(amenityColumnMap).map(col => [
                      col, row[col] === 'TRUE' || row[col] === true
                    ])
                  )
                }));

                setRentalData(processedData);

                // Build regions
                const cityNeighborhoods = {};
                processedData.forEach(row => {
                  if (row.City && row.Neighbourhood) {
                    if (!cityNeighborhoods[row.City]) {
                      cityNeighborhoods[row.City] = new Set();
                    }
                    cityNeighborhoods[row.City].add(row.Neighbourhood);
                  }
                });

                const regionsList = [{ value: 'All Cities', label: 'All Cities' }];
                Object.keys(cityNeighborhoods).sort().forEach(city => {
                  regionsList.push({ value: city, label: city });
                  Array.from(cityNeighborhoods[city]).sort().forEach(neighborhood => {
                    regionsList.push({ value: neighborhood, label: neighborhood, parent: city });
                  });
                });

                setRegions(regionsList);
                setUsingSampleData(usingSample);
                setLoading(false);
              } catch (error) {
                console.error('Error processing data:', error);
                setError(error.message);
                setLoading(false);
              }
            };

            loadData();
          }, []);

          // Filter data
          const filteredData = useMemo(() => {
            if (!rentalData.length) return [];

            let filtered = rentalData;

            if (selectedRegion && selectedRegion !== 'All Cities') {
              const isCity = rentalData.some(unit => unit.City === selectedRegion);
              if (isCity) {
                filtered = filtered.filter(unit => unit.City === selectedRegion);
              } else {
                filtered = filtered.filter(unit => unit.Neighbourhood === selectedRegion);
              }
            }

            if (selectedAmenities.length > 0) {
              filtered = filtered.filter(unit => {
                return selectedAmenities.every(amenityId => {
                  const columnName = amenityColumnMap[amenityId];
                  return unit[columnName] === true;
                });
              });
            }

            return filtered;
          }, [rentalData, selectedRegion, selectedAmenities]);

          // Calculate KPIs
          const kpis = useMemo(() => {
            if (filteredData.length === 0) {
              return {
                studio: { avgRent: 0, avgPricePerSqft: 0 },
                '1bed': { avgRent: 0, avgPricePerSqft: 0 },
                '2bed': { avgRent: 0, avgPricePerSqft: 0 },
                '3bed': { avgRent: 0, avgPricePerSqft: 0 }
              };
            }

            const unitTypes = ['studio', '1bed', '2bed', '3bed'];
            const result = {};

            unitTypes.forEach(unitType => {
              const units = filteredData.filter(unit => unit['Unit Size'] === unitType);
              if (units.length > 0) {
                const avgRent = units.reduce((sum, unit) => sum + unit.Rent, 0) / units.length;
                const avgPricePerSqft = units.reduce((sum, unit) => sum + unit['Avg Rent/sqft'], 0) / units.length;
                result[unitType] = {
                  avgRent: Math.round(avgRent),
                  avgPricePerSqft: parseFloat(avgPricePerSqft.toFixed(2))
                };
              } else {
                result[unitType] = { avgRent: 0, avgPricePerSqft: 0 };
              }
            });

            return result;
          }, [filteredData]);

          const handleAmenityToggle = (amenityId) => {
            if (selectedAmenities.includes(amenityId)) {
              setSelectedAmenities(selectedAmenities.filter(id => id !== amenityId));
            } else {
              setSelectedAmenities([...selectedAmenities, amenityId]);
            }
          };

          if (loading) {
            return (
              <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                <div className="text-center">
                  <div className="text-xl font-semibold text-gray-900">Loading Dashboard...</div>
                  <div className="text-gray-600 mt-2">Fetching rental data...</div>
                </div>
              </div>
            );
          }

          if (error) {
            return (
              <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                <div className="text-center">
                  <div className="text-xl font-semibold text-red-900">Error Loading Data</div>
                  <div className="text-red-600 mt-2">{error}</div>
                </div>
              </div>
            );
          }

          return (
            <div className="p-6 bg-gray-50 min-h-screen">
              <div className="max-w-7xl mx-auto space-y-6">
                {/* Header */}
                <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                  <div>
                    <h1 className="text-3xl font-bold text-gray-900">Vancouver Rental Dashboard</h1>
                    <p className="text-gray-600 mt-1">Purpose-built rental units market analysis</p>
                    <p className="text-sm text-gray-500 mt-1">
                      {usingSampleData ? (
                        <>Showing {filteredData.length} units from {rentalData.length} sample units (Demo dataset)</>
                      ) : (
                        <>Showing {filteredData.length} units from {rentalData.length} total units</>
                      )}
                    </p>
                  </div>
                  
                  {/* Filters */}
                  <div className="flex flex-wrap gap-3">
                    <Select value={selectedRegion} onChange={setSelectedRegion} className="w-64">
                      <optgroup label="All Regions">
                        <option value="All Cities">All Cities</option>
                      </optgroup>
                      <optgroup label="Municipalities">
                        {regions.filter(r => !r.parent && r.value !== 'All Cities').map(region => (
                          <option key={region.value} value={region.value}>{region.label}</option>
                        ))}
                      </optgroup>
                      <optgroup label="Neighborhoods">
                        {regions.filter(r => r.parent).map(region => (
                          <option key={region.value} value={region.value}>{region.label}</option>
                        ))}
                      </optgroup>
                    </Select>

                    <div className="relative">
                      <Button 
                        variant="outline" 
                        onClick={() => setShowAmenityFilter(!showAmenityFilter)}
                        className="min-w-40"
                      >
                        🏠 Amenities ({selectedAmenities.length})
                      </Button>
                      
                      {showAmenityFilter && (
                        <div className="absolute top-full left-0 mt-2 w-64 bg-white border rounded-lg shadow-lg p-3 z-10">
                          <h4 className="font-medium mb-3">Filter by Amenities</h4>
                          {amenities.map(amenity => (
                            <div key={amenity.id} className="flex items-center space-x-2 mb-2">
                              <input
                                type="checkbox"
                                id={amenity.id}
                                checked={selectedAmenities.includes(amenity.id)}
                                onChange={() => handleAmenityToggle(amenity.id)}
                                className="rounded"
                              />
                              <label htmlFor={amenity.id} className="text-sm">
                                {amenity.name}
                              </label>
                            </div>
                          ))}
                          <Button 
                            variant="outline" 
                            onClick={() => setSelectedAmenities([])}
                            className="w-full mt-3 text-sm"
                          >
                            Clear Amenities
                          </Button>
                        </div>
                      )}
                    </div>

                    {(selectedRegion !== 'Vancouver' || selectedAmenities.length > 0) && (
                      <Button 
                        variant="outline" 
                        onClick={() => {
                          setSelectedRegion('Vancouver');
                          setSelectedAmenities([]);
                        }}
                      >
                        Clear All Filters
                      </Button>
                    )}
                  </div>
                </div>

                {/* Market Summary Cards */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                  {['studio', '1bed', '2bed', '3bed'].map(unitType => (
                    <Card key={unitType}>
                      <CardHeader className="pb-3">
                        <CardTitle className="text-sm font-medium text-gray-600 flex items-center justify-between">
                          {unitType === 'studio' ? 'Studio' : `${unitType.charAt(0).toUpperCase()}${unitType.slice(1)}`}
                          <span className="text-gray-400">—</span>
                        </CardTitle>
                      </CardHeader>
                      <CardContent className="pt-0">
                        <div className="space-y-2">
                          <div>
                            <div className="text-2xl font-bold text-gray-900">
                              ${kpis[unitType].avgRent.toLocaleString()}
                            </div>
                            <div className="text-xs text-gray-500">Average Rent</div>
                          </div>
                          <div>
                            <div className="text-lg font-semibold text-blue-600">
                              ${kpis[unitType].avgPricePerSqft}/sqft
                            </div>
                          </div>
                        </div>
                      </CardContent>
                    </Card>
                  ))}
                </div>

                {/* Status Message */}
                {usingSampleData && (
                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <div className="text-yellow-800">
                      <strong>Demo Mode:</strong> Using sample data. Deploy this HTML file to GitHub Pages to load your full dataset automatically.
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        };

        ReactDOM.render(<VancouverRentalDashboard />, document.getElementById('root'));
    </script>
</body>
</html>
